---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../../consts';
import { getCollection } from 'astro:content';

export async function getStaticPaths({ paginate }: any) {
  const posts = (await getCollection('blog'))
    .sort((a: { data: { pubDate: string | number | Date; }; }, b: { data: { pubDate: string | number | Date; }; }) => {
      const dateA = new Date(a.data.pubDate);
      const dateB = new Date(b.data.pubDate);
      return dateB.getTime() - dateA.getTime();
    });

  return paginate(posts, { pageSize: 12 });
}

const { page } = Astro.props;

function formatDate(date: Date | string) {
  try {
    const d = new Date(date);
    if (isNaN(d.getTime())) {
      return '日付なし';
    }
    return d.toLocaleDateString('ja-JP', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  } catch {
    return '日付なし';
  }
}
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <BaseHead title="Blog" description="All blog posts" />
  </head>
  <body>
    <Header />
    <main>
      <section>
        <h1>Blog</h1>
        <p>すべての記事（{page.total}件）{page.currentPage > 1 && ` - ページ ${page.currentPage}`}</p>

        <ul class="blog-list">
          {page.data.map((post: { id: string; data: { customSlug?: string; heroImage: string | null | undefined; title: unknown; pubDate: string | Date; description: unknown; tags: string[]; }; }) => {
            const postSlug = post.data.customSlug || post.id.replace(/\.(md|mdx)$/, '');

            return (
              <li>
                <a href={`/daily-scraps/blog/${postSlug}/`}>
                  <article>
                    {post.data.heroImage && (
                      <img
                        width={720}
                        height={360}
                        src={post.data.heroImage}
                        alt={String(post.data.title)}
                        class="hero-image"
                      />
                    )}
                    <div class="content">
                      <h2>{post.data.title}</h2>
                      <time class="date">{formatDate(post.data.pubDate)}</time>
                      <p class="description">{post.data.description}</p>
                      {post.data.tags && post.data.tags.length > 0 && (
                        <div class="tags">
                          {post.data.tags.map((tag: string) => (
                            <span class="tag">#{tag}</span>
                          ))}
                        </div>
                      )}
                    </div>
                  </article>
                </a>
              </li>
            );
          })}
        </ul>

        <nav class="pagination" aria-label="ページネーション">
          {page.url.prev && (
            <a href={page.url.prev} class="pagination-link prev">
              ← 前のページ
            </a>
          )}

          <div class="page-numbers">
            {Array.from({ length: page.lastPage }, (_, i) => i + 1).map((num) => (
              num === page.currentPage ? (
                <span class="page-number current">{num}</span>
              ) : (
                <a
                  href={num === 1 ? '/daily-scraps/blog/' : `/daily-scraps/blog/${num}/`}
                  class="page-number"
                >
                  {num}
                </a>
              )
            ))}
          </div>

          {page.url.next && (
            <a href={page.url.next} class="pagination-link next">
              次のページ →
            </a>
          )}
        </nav>
      </section>
    </main>
    <Footer />
  </body>
</html>

<style>
  main {
    padding: 2rem;
    max-width: 900px;
    margin: 0 auto;
  }

  h1 {
    margin-bottom: 0.5rem;
  }

  section > p {
    color: #666;
    margin-bottom: 2rem;
  }

  .blog-list {
    list-style: none;
    padding: 0;
    display: grid;
    gap: 2rem;
  }

  .blog-list li {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .blog-list li:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
  }

  .blog-list a {
    text-decoration: none;
    color: inherit;
  }

  .hero-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
  }

  .content {
    padding: 1.5rem;
  }

  .blog-list h2 {
    margin: 0 0 0.5rem 0;
    color: #333;
    font-size: 1.5rem;
  }

  .date {
    display: block;
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
  }

  .description {
    color: #555;
    line-height: 1.6;
    margin: 0.5rem 0;
  }

  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
  }

  .tag {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: #f0f0f0;
    border-radius: 1rem;
    font-size: 0.875rem;
    color: #666;
  }

  .pagination {
    margin-top: 3rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .pagination-link {
    padding: 0.75rem 1.5rem;
    background: rgb(var(--accent));
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 500;
    transition: background 0.2s;
  }

  .pagination-link:hover {
    background: rgb(var(--accent-dark));
  }

  .pagination-link.prev {
    margin-right: auto;
  }

  .pagination-link.next {
    margin-left: auto;
  }

  .page-numbers {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .page-number {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 2.5rem;
    height: 2.5rem;
    padding: 0 0.5rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    text-decoration: none;
    color: #333;
    font-weight: 500;
    transition: all 0.2s;
  }

  .page-number:hover {
    background: #f5f5f5;
    border-color: rgb(var(--accent));
  }

  .page-number.current {
    background: rgb(var(--accent));
    color: white;
    border-color: rgb(var(--accent));
  }

  /* レスポンシブ対応 */
  @media (max-width: 768px) {
    main {
      padding: 1rem;
    }

    h1 {
      font-size: 1.8rem;
    }

    .blog-list {
      gap: 1.5rem;
    }

    .hero-image {
      height: 180px;
    }

    .content {
      padding: 1.25rem;
    }

    .blog-list h2 {
      font-size: 1.3rem;
    }

    .pagination {
      margin-top: 2rem;
    }
  }

  @media (max-width: 600px) {
    .pagination {
      flex-direction: column;
    }

    .pagination-link.prev,
    .pagination-link.next {
      margin: 0;
      width: 100%;
      text-align: center;
    }

    .page-numbers {
      order: -1;
      justify-content: center;
    }
  }

  @media (max-width: 480px) {
    main {
      padding: 0.75rem;
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 0.375rem;
    }

    section > p {
      font-size: 0.9rem;
      margin-bottom: 1.5rem;
    }

    .blog-list {
      gap: 1rem;
    }

    .blog-list li {
      border-radius: 8px;
    }

    .hero-image {
      height: 160px;
    }

    .content {
      padding: 1rem;
    }

    .blog-list h2 {
      font-size: 1.15rem;
      margin-bottom: 0.375rem;
    }

    .date {
      font-size: 0.85rem;
    }

    .description {
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .tags {
      gap: 0.375rem;
      margin-top: 0.75rem;
    }

    .tag {
      padding: 0.2rem 0.5rem;
      font-size: 0.8rem;
    }

    .pagination-link {
      padding: 0.625rem 1rem;
      font-size: 0.9rem;
    }

    .page-number {
      min-width: 2rem;
      height: 2rem;
      font-size: 0.9rem;
    }
  }
</style>
